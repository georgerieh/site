<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 1 Detail (Final)</title>
    <style>
        /* Base Styling */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f0f0f5;
        }

        /* Task Header */
        .task-header-card {
            background-color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .task-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .task-title-row h3 {
            font-size: 1.5em;
            margin: 0;
            display: flex;
            align-items: center;
        }

        .task-title-row h3 span {
            margin-left: 8px;
            background-color: #eee;
            color: #555;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.6em;
            font-weight: bold;
        }

        .info-icon {
            font-size: 1.2em;
            color: #555;
            cursor: pointer;
        }

        /* Editable Text Inputs (General Styling) */
        .editable-text {
            border: none;
            padding: 0;
            margin: 0;
            font-family: inherit;
            color: inherit;
            background: none;
            width: 100%;
            box-sizing: border-box;
        }
        
        .task-title-row input {
            font-size: 1em; 
            font-weight: bold; 
            color: black;
        }

        /* Task Details */
        .task-details {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 15px;
        }
        
        .deadline-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            color: #333;
        }
        
        .deadline-container label {
            margin-right: 5px;
            color: #555;
        }

        .deadline-container input[type="date"] {
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            flex-grow: 1;
        }
        
        /* Responsibility/Archive Buttons */
        .responsible-action {
            display: flex;
            justify-content: flex-start;
            margin-top: 10px;
        }
        
        .responsible-action button {
            padding: 8px 15px;
            border: none;
            background-color: #6200ea;
            color: white;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.8em;
        }

        .action-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 5px;
        }

        .action-buttons button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #555;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.8em;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background-color: #7a63c6;
            border-radius: 4px;
            width: 100%;
        }

        /* Section Card (Checklist/Text Blocks) */
        .section-card {
            background-color: white;
            border-radius: 12px;
            padding: 10px 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .section-card h4 {
            margin-top: 0;
        }
        
        .section-card .editable-text.heading {
            font-size: 1.1em;
            font-weight: bold;
            padding-bottom: 5px;
        }

        /* Subtask List Items */
        .subtask-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .subtask-item:last-child {
            border-bottom: none;
        }

        .subtask-item input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            accent-color: #7a63c6;
            flex-shrink: 0;
        }
        
        .subtask-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-right: 10px;
        }
        
        .subtask-content .subtask-title-input {
             font-weight: 500;
             margin-bottom: 2px;
        }
        
        .subtask-content .subtask-desc-input {
            font-size: 0.8em;
            color: #777;
        }
        
        /* Subtask Calendar Input */
        .subtask-calendar-container {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        .subtask-calendar-container input[type="date"] {
            width: 25px; /* Small size */
            height: 25px;
            padding: 0;
            border: none;
            opacity: 0; /* Hide the default date input */
            position: absolute;
            cursor: pointer;
        }

        .calendar-icon-btn {
            font-size: 1.2em;
            color: #555;
            cursor: pointer;
        }

        /* Add New Button Styling */
        .add-new-btn {
            display: flex;
            align-items: center;
            padding: 10px 0;
            color: #7a63c6;
            font-weight: bold;
            cursor: pointer;
        }
        
        .add-new-btn span {
            margin-right: 8px;
            font-size: 1.5em;
        }

        /* Dynamic Text Fields */
        .dynamic-text-field {
            padding: 10px 0 20px 0;
        }
        
        .dynamic-text-field-inner {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 15px;
        }
        
        .dynamic-text-field-inner textarea {
            width: 100%;
            height: 80px;
            padding: 0;
            border: none;
            box-sizing: border-box;
            font-size: 0.9em;
            resize: vertical;
            color: #333;
        }
        
        .delete-btn {
            color: red;
            font-size: 0.8em;
            margin-top: 5px;
            cursor: pointer;
            text-align: right;
            display: block;
        }

        /* Global Action Buttons (Moved to the end) */
        .global-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px; /* Separator from content above */
            margin-bottom: 10px;
        }
        
        .global-actions button {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
            font-size: 0.9em;
        }
        
        .global-actions .notify-btn {
            background-color: #6200ea;
            color: white;
        }
        
        .global-actions .discuss-btn {
            background-color: #e0e0e0;
            color: #333;
        }
        
        /* Quick Replies/Inputs */
        .quick-reply-container {
             margin-bottom: 20px;
        }
        
        .quick-reply-item {
            position: relative;
            margin-bottom: 10px;
        }

        .quick-reply-input {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 0.9em;
            background-color: white;
            padding-right: 40px; /* Space for delete button */
        }
        
        .quick-reply-delete {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            color: #888;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }

        /* Footer Navigation */
        .footer-nav {
            display: flex;
            justify-content: flex-start;
            padding-top: 15px;
        }

        .back-btn {
            width: 50px;
            height: 50px;
            background-color: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="task-header-dynamic"></div>
    <div id="checklist-container"></div>
    <div class="add-new-btn" onclick="addNewChecklist()">
        <span>+</span> Add new checklist
    </div>
    <h4 style="margin-top: 0; margin-bottom: 10px;">Supporting Details</h4>
    <div id="text-field-container"></div>
    <div class="add-new-btn" onclick="addDynamicTextField()">
        <span>+</span> Add new text field
    </div>
    <div class="global-actions">
        <button class="notify-btn" onclick="notifyEveryone()">Notify everyone</button>
        <button class="discuss-btn" onclick="openChat()">Discuss in chat</button>
    </div>
    <div class="quick-reply-container" id="quick-reply-container"></div>
    <div class="footer-nav">
        <div class="back-btn" onclick="history.back()">&#8592;</div>
    </div>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <div id="teamContainer"></div>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyApNGohDeMrQWBewscU5PuBRR6BQ3m2uQQ",
      authDomain: "colabspace-aed91.firebaseapp.com",
      projectId: "colabspace-aed91",
      storageBucket: "colabspace-aed91.firebasestorage.app",
      messagingSenderId: "1096273499808",
      appId: "1:1096273499808:web:42012f619a3cbced321bc5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

        // --- GLOBAL COUNTERS ---
        let checklistCounter = 1;
        let fieldCounter = 1;
        let subtaskCounter = 1;
        let replyCounter = 1;

        // --- GET THE TASK ID (from URL or hardcoded) ---
        // Example: ?task_id=abc123
        function getTaskIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('task_id') || "demo-task-1"; // fallback for demo
        }

        // --- DYNAMIC RENDERING FROM FIRESTORE ---
        async function renderTaskFromFirestore() {
            const taskId = Number(getTaskIdFromUrl()); // ensure numeric
            const taskSnap = await db.collection('tasks').where('task_id', '==', taskId).get();
        
            if (taskSnap.empty) {
                document.getElementById('task-header-dynamic').innerHTML = "<div class='section-card'>Task not found.</div>";
                return;
            }
        
            const task = taskSnap.docs[0].data();
            renderTaskHeader(task);
            renderChecklists(task);
            renderTextFields(task);
            renderQuickReplies(task);
        }

        // --- HEADER ---
        async function renderTaskHeader(task) {
            // Fetch responsible user's email
            let responsibleEmail = "";
            if (task.user_id) {
                const userSnap = await db.collection("user").where("id", "==", task.user_id).get();
                if (!userSnap.empty) responsibleEmail = userSnap.docs[0].data().email;
            }
        
            // Compute progress bar: ratio of unchecked checklist items
            let checklist = task.info && task.info.checklist ? task.info.checklist : [];
            const totalItems = checklist.length;
            const remaining = checklist.filter(c => !c.done).length;
            const progressPercent = totalItems ? Math.round((totalItems - remaining)/totalItems*100) : 0;
        
            document.getElementById('task-header-dynamic').innerHTML = `
                <div class="task-header-card">
                    <div class="task-title-row">
                        <h3>${escapeHtml(task.title || '')}</h3>
                        <span>Status: ${progressPercent}%</span>
                    </div>
                    <div class="task-details">
                        <p>Responsible: ${escapeHtml(responsibleEmail)}</p>
                        <div class="progress-bar"><div class="progress-fill" style="width:${progressPercent}%"></div></div>
                    </div>
                </div>
            `;
        }

        // --- CHECKLISTS & SUBTASKS ---
        function renderChecklists(task) {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            checklistCounter = 1;
        
            if (!task.info || !Array.isArray(task.info.checklist)) return;
        
            task.info.checklist.forEach((item, idx) => {
                const checklistId = checklistCounter++;
                const card = document.createElement('div');
                card.className = 'section-card';
                card.id = `checklist-card-${checklistId}`;
        
                card.innerHTML = `
                    <input type="text" class="editable-text heading" value="${escapeHtml(item.Title || '')}" onblur="updateChecklistHeading(${checklistId}, this.value)">
                    <input type="date" value="${item.Deadline ? formatDeadline(item.Deadline) : ''}" onchange="updateChecklistDeadline(${checklistId}, this.value)">
                    <textarea onblur="updateChecklistDescription(${checklistId}, this.value)">${escapeHtml(item.Description || '')}</textarea>
                    <input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleChecklistDone(${checklistId}, this.checked)">
                    <button onclick="deleteChecklist(${checklistId})">Delete</button>
                `;
                container.appendChild(card);
            });
        }


        // --- DYNAMIC TEXT FIELDS (Supporting Details) ---
        function renderTextFields(task) {
            const container = document.getElementById('text-field-container');
            container.innerHTML = '';
            fieldCounter = 1;
        
            if (Array.isArray(task.comments)) {
                task.comments.forEach((comment, idx) => {
                    const fieldId = fieldCounter++;
                    const div = document.createElement('div');
                    div.className = 'dynamic-text-field';
                    div.id = `text-field-${fieldId}`;
                    div.innerHTML = `
                        <textarea placeholder="Enter details here..." onblur="saveDynamicField(${fieldId}, this.value)">${escapeHtml(comment)}</textarea>
                        <button onclick="deleteDynamicField(${fieldId})">Delete</button>
                    `;
                    container.appendChild(div);
                });
            }
        }

        // --- QUICK REPLIES ---
        

        // --- HTML ESCAPE ---
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function(m) {
                return ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                })[m];
            });
        }

        // --- INITIALIZE ON LOAD ---
        window.addEventListener('DOMContentLoaded', () => {
            renderTaskFromFirestore();
        });

        // --- Core Task Updates ---
        function updateTaskTitle(title) {
            console.log(`Task title updated to: ${title} (API call to PUT /api/tasks/{taskId})`);
        }
        function updateDeadline(date) {
            console.log(`Deadline set to: ${date} (API call to PUT /api/tasks/{taskId})`);
        }
        function setResponsible() {
            console.log('User set as responsible. (API call to POST /api/tasks/{taskId}/responsible)');
        }
        function archiveTask() {
            console.log('Task archived! (API call to POST /api/tasks/{taskId}/archive)');
        }

        // --- Dynamic Text Fields ---
        function addDynamicTextField() {
            const container = document.getElementById('text-field-container');
            const newFieldId = fieldCounter++;
            
            const newField = document.createElement('div');
            newField.className = 'dynamic-text-field';
            newField.id = `text-field-${newFieldId}`;
            newField.innerHTML = `
                <div class="section-card dynamic-text-field-inner">
                    <input type="text" class="editable-text heading" value="New Text Field ${newFieldId}" onblur="updateFieldHeading(${newFieldId}, this.value)">
                    <textarea placeholder="Enter details here..." onblur="saveDynamicField(${newFieldId}, this.value)"></textarea>
                    <span class="delete-btn" onclick="deleteDynamicField(${newFieldId})">Delete Field</span>
                </div>
            `;
            container.appendChild(newField);
            console.log(`New text field added. (API call to POST /api/tasks/{taskId}/fields)`);
        }
        
        function updateFieldHeading(fieldId, heading) {
            console.log(`Field ${fieldId} heading updated: ${heading} (API call to PUT /api/tasks/{taskId}/fields/${fieldId})`);
        }
        
        function saveDynamicField(fieldId, content) {
            const taskId = getTaskIdFromUrl();
            const path = `comments.${fieldId-1}`;
            db.collection('tasks').doc(task_id).update({ [path]: content });
        }
        
        function deleteDynamicField(fieldId) {
            if (confirm(`Are you sure you want to delete Text Field ${fieldId}?`)) {
                document.getElementById(`text-field-${fieldId}`).remove();
                console.log(`Text Field ${fieldId} deleted. (API call to DELETE /api/tasks/{taskId}/fields/${fieldId})`);
            }
        }

        // --- Dynamic Checklists ---
        function addNewChecklist() {
            const container = document.getElementById('checklist-container');
            const newChecklistId = checklistCounter++;
            
            const newCard = document.createElement('div');
            newCard.className = 'section-card';
            newCard.id = `checklist-card-${newChecklistId}`;
            newCard.innerHTML = `
                <input type="text" class="editable-text heading" value="New Checklist ${newChecklistId}" onblur="updateChecklistHeading(${newChecklistId}, this.value)">
                <div id="subtask-list-${newChecklistId}">
                    </div>
                <div class="add-new-btn" onclick="addNewSubtask(${newChecklistId})">
                    <span>+</span> Add new detail
                </div>
                <span class="delete-btn" onclick="deleteChecklist(${newChecklistId})">Delete Checklist</span>
            `;
            container.appendChild(newCard);
            console.log(`New checklist ${newChecklistId} added. (API call to POST /api/tasks/{taskId}/checklists)`);
            addNewSubtask(newChecklistId);
        }
        
        function updateChecklistHeading(id, value) {
            const taskId = getTaskIdFromUrl();
            db.collection('tasks').doc(taskId).update({
                [`info.checklist.${id-1}.Title`]: value
            });
        }
        
        function deleteChecklist(checklistId) {
            if (confirm(`Are you sure you want to delete Checklist ${checklistId}?`)) {
                document.getElementById(`checklist-card-${checklistId}`).remove();
                console.log(`Checklist ${checklistId} deleted. (API call to DELETE /api/tasks/{taskId}/checklists/${checklistId})`);
            }
        }
        
        function addNewSubtask(checklistId) {
            const list = document.getElementById(`subtask-list-${checklistId}`);
            const subtaskId = subtaskCounter++; 
            
            const newItem = document.createElement('div');
            newItem.className = 'subtask-item';
            newItem.id = `subtask-${checklistId}-${subtaskId}`;
            newItem.innerHTML = `
                <input type="checkbox" onclick="toggleSubtask(${checklistId}, ${subtaskId})">
                <div class="subtask-content">
                    <input type="text" class="editable-text subtask-title-input" value="" placeholder="New Subtask Title" onblur="updateSubtaskTitle(${checklistId}, ${subtaskId}, this.value)">
                    <input type="text" class="editable-text subtask-desc-input" value="Description" placeholder="Description (optional)" onblur="updateSubtaskDescription(${checklistId}, ${subtaskId}, this.value)">
                </div>
                <div class="subtask-calendar-container" onclick="openSubtaskDeadline(${checklistId}, ${subtaskId})">
                    <input type="date" onchange="updateSubtaskDeadline(${checklistId}, ${subtaskId}, this.value)">
                    <span class="calendar-icon-btn">ðŸ“…</span> 
                </div>
                <span class="quick-reply-delete" style="font-size: 1em; right: -5px;" onclick="deleteSubtask(${checklistId}, ${subtaskId})">&times;</span>
            `;
            list.appendChild(newItem);
            console.log(`New subtask ${subtaskId} added to checklist ${checklistId}. (API call to POST /api/tasks/{taskId}/checklists/${checklistId}/subtasks)`);
        }
        
        function deleteSubtask(checklistId, subtaskId) {
            if (confirm(`Delete subtask ${subtaskId}?`)) {
                document.getElementById(`subtask-${checklistId}-${subtaskId}`).remove();
                console.log(`Subtask ${subtaskId} deleted. (API call to DELETE /api/tasks/{taskId}/checklists/${checklistId}/subtasks/${subtaskId})`);
            }
        }
        
        function toggleSubtask(checklistId, subtaskId) {
            console.log(`Checklist ${checklistId}, Subtask ${subtaskId} status toggled! (API call to PUT /api/tasks/{taskId}/checklists/${checklistId}/subtasks/${subtaskId})`);
        }
        
        function updateSubtaskTitle(checklistId, subtaskId, title) {
            console.log(`C${checklistId}, S${subtaskId} title updated: ${title} (API call to PUT /api/tasks/{taskId}/checklists/${checklistId}/subtasks/${subtaskId})`);
        }
        
        function updateSubtaskDescription(checklistId, subtaskId, desc) {
            console.log(`C${checklistId}, S${subtaskId} description updated: ${desc} (API call to PUT /api/tasks/{taskId}/checklists/${checklistId}/subtasks/${subtaskId})`);
        }
        
        function updateSubtaskDeadline(checklistId, subtaskId, date) {
            console.log(`C${checklistId}, S${subtaskId} deadline set to: ${date} (API call to PUT /api/tasks/{taskId}/checklists/${checklistId}/subtasks/${subtaskId})`);
        }
        
        function openSubtaskDeadline(checklistId, subtaskId) {
            // Programmatically trigger the date picker
            const input = document.querySelector(`#subtask-${checklistId}-${subtaskId} input[type="date"]`);
            if (input) {
                input.click();
            }
        }

        // --- Quick Replies ---
        function sendQuickReply(replyId, message) {
            console.log(`Quick reply ${replyId} sent: "${message}" (API call to POST /api/tasks/{taskId}/messages)`);
        }
        
        function deleteQuickReply(replyId) {
            if (confirm('Are you sure you want to delete this quick reply field?')) {
                document.getElementById(`quick-reply-${replyId}`).remove();
                // If these are user-defined quick replies, an API call would be needed:
                // console.log(`Quick reply field ${replyId} deleted. (API call to DELETE /api/users/{userId}/quick-replies/${replyId})`);
            }
        }
        
        // --- Global Actions (Same as previous) ---
        function notifyEveryone() {
            console.log('Notification sent to everyone! (API call to POST /api/tasks/{taskId}/notify)');
        }
        function openChat() {
            console.log('Opening task chat... (API call to GET /api/tasks/{taskId}/chat)');
        }
    </script>

</body>
</html>