<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Tasks</title>
 
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Base & Mobile  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:#f0f0f5;
      min-height:100vh;
      padding-bottom:100px;
    }
    .container { padding:12px; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Task Card  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task-card {
      background:#fff;
      border-radius:14px;
      margin-bottom:12px;
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 6px rgba(0,0,0,.07);
      border:1px solid #e2e2e2;
      cursor:pointer;
    }
    .task-info { flex:1; padding-right:12px; }
    .task-info h3 { margin:0 0 4px; font-size:1.08em; font-weight:600; }
    .task-info p { margin:2px 0; font-size:.9em; color:#555; }

    .progress-bar { height:6px; background:#e0e0e0; border-radius:3px; overflow:hidden; margin-top:6px; }
    .progress-fill { height:100%; background:#7a63c6; border-radius:3px; }

    .arrow { font-size:1.6em; color:#555; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Footer Nav  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer-nav {
      position:fixed;
      bottom:0; left:0; right:0;
      background:#fff;
      padding:12px 8px;
      display:flex;
      align-items:center;
      border-top:1px solid #eee;
      box-shadow:0 -2px 6px rgba(0,0,0,.05);
      z-index:10;
    }
    .back-arrow { font-size:1.6em; margin-right:8px; cursor:pointer; }
    .footer-button {
      flex:1;
      text-align:center;
      padding:10px 0;
      border-radius:20px;
      font-weight:600;
      font-size:.95em;
      cursor:pointer;
      transition:background .2s, color .2s;
    }
    .footer-button.active { background:#333; color:#fff; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Addâ€‘Task FAB  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #add-task-btn {
      position:fixed;
      bottom:80px; right:20px;
      padding:14px 22px;
      border-radius:50px;
      background:#7a63c6;
      color:#fff;
      border:none;
      font-weight:600;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      z-index:100;
      cursor:pointer;
    }
  </style>
</head>
<body>

  <div class="container"><!-- tasks injected here --></div>

  <!-- FAB -->
  <button id="add-task-btn">Add New Task</button>

  <!-- Footer (must be AFTER the script that defines the functions) -->
  <div class="footer-nav">
    <span class="back-arrow" onclick="window.location.href='/dashboard.html'">â†©</span>
    <div class="footer-button your-tasks active"   onclick="showYourTasks()">Your tasks</div>
    <div class="footer-button all-tasks"          onclick="showAllTasks()">All tasks</div>
    <div class="footer-button archived-tasks"    onclick="showArchivedTasks()">Archive</div>
  </div>

  <!-- ---------------------------------------------------------- -->
  <!--                     ALL JAVASCRIPT                         -->
  <!-- ---------------------------------------------------------- -->
  <script>
    /* â”€â”€â”€â”€â”€â”€â”€ Firebase init â”€â”€â”€â”€â”€â”€â”€ */
    const firebaseConfig = {
      apiKey: "AIzaSyApNGohDeMrQWBewscU5PuBRR6BQ3m2uQQ",
      authDomain: "colabspace-aed91.firebaseapp.com",
      projectId: "colabspace-aed91",
      storageBucket: "colabspace-aed91.firebasestorage.app",
      messagingSenderId: "1096273499808",
      appId: "1:1096273499808:web:42012f619a3cbced321bc5"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.firestore();
    const auth = firebase.auth();

    let allTasks        = [];
    let currentUser     = null;
    let currentTeamId   = null;
    let showMineOnly    = true;
    let showArchivedOnly= false;

    /* â”€â”€â”€â”€â”€â”€â”€ Helper: find userâ€™s numeric id & team â”€â”€â”€â”€â”€â”€â”€ */
    async function loadCurrentTeam() {
      const projectId = 1;
      const userSnap = await db.collection('user')
        .where('email','==',currentUser.email).limit(1).get();
      if (userSnap.empty) throw new Error('User not in user collection');
      const numericId = userSnap.docs[0].data().id;

      const teamSnap = await db.collection('team')
        .where('project_id','==',projectId)
        .where('users','array-contains',numericId).limit(1).get();
      if (teamSnap.empty) throw new Error('Team not found');
      currentTeamId = teamSnap.docs[0].data().team_id;
    }

    /* â”€â”€â”€â”€â”€â”€â”€ Realâ€‘time tasks listener â”€â”€â”€â”€â”€â”€â”€ */
    function startTaskListener() {
      db.collection('tasks').onSnapshot(snap => {
        allTasks = snap.docs.map(d => ({id:d.id, ...d.data()}));
        renderTasks();
      });
    }

    /* â”€â”€â”€â”€â”€â”€â”€ Render filtered tasks â”€â”€â”€â”€â”€â”€â”€ */
    async function renderTasks() {
      const container = document.querySelector('.container');
      container.innerHTML = '';

      let filtered = [];

      if (!currentTeamId) {
        container.innerHTML = '<p>Loading teamâ€¦</p>';
        return;
      }

      console.log("All tasks:", allTasks);

      if (showArchivedOnly) {
        filtered = allTasks.filter(t =>
          t.is_archived === true && t.is_deleted !== true && t.team_id == currentTeamId);
      } else if (showMineOnly) {
        filtered = allTasks.filter(t =>
          t.email === currentUser.email &&
          t.is_archived !== true && t.is_deleted !== true &&
          t.team_id == currentTeamId);
      } else {
        filtered = allTasks.filter(t =>
          t.team_id == currentTeamId &&
          t.is_archived !== true && t.is_deleted !== true);
      }

      console.log("Filtered tasks:", filtered);

      if (!filtered.length) {
        container.innerHTML = '<p>No tasks to display.</p>';
        return;
      }

      for (const task of filtered) {
        const deadline = task.deadline && typeof task.deadline === 'number'
          ? new Date(task.deadline * 86400000).toLocaleDateString()
          : (new Date(task.deadline).toLocaleDateString() || 'â€”');

        let pct = 0;
        if (task.status && task.status.toLowerCase() === 'completed') {
          pct = 100;
        } else if (Array.isArray(task.checklist) && task.checklist.length > 0) {
          const doneCount = task.checklist.filter(c => c.done === true).length;
          pct = Math.round((doneCount / task.checklist.length) * 100);
        } else {
          pct = 0;
        }

        const card = document.createElement('div');
        card.className = 'task-card';
        card.onclick = () => goToTask(card);

        // Create info first
        const info = document.createElement('div');
        info.className = 'task-info';
        info.innerHTML = `
          <h3>${task.title || 'Untitled'}</h3>
          <p>Responsible: ${task.email || 'â€”'}</p>
          <p>Deadline: ${deadline}</p>
          <p>Status: ${pct}% Done</p>
        `;
        if (pct > 0) {
          const bar = document.createElement('div');
          bar.className = 'progress-bar';
          const fill = document.createElement('div');
          fill.className = 'progress-fill';
          fill.style.width = pct + '%';
          bar.appendChild(fill);
          info.appendChild(bar);
        }

        // Archive button (only when not in archive view)
        if (!showArchivedOnly) {
          const arch = document.createElement('span');
          arch.textContent = 'ğŸ“¦';
          arch.title = 'Archive Task';
          arch.style.marginRight = '12px';
          arch.style.cursor = 'pointer';
          arch.style.fontSize = '1.2em';
          arch.onclick = async e => {
            e.stopPropagation();
            await db.collection('tasks').doc(task.id).update({is_archived:true});
          };

          const leftControls = document.createElement('div');
          leftControls.style.display = 'flex';
          leftControls.style.alignItems = 'center';
          leftControls.appendChild(arch);

          card.appendChild(leftControls);
        }

        card.appendChild(info);

        const arrow = document.createElement('span');
        arrow.textContent = 'â¡ï¸';
        arrow.style.cursor = 'pointer';
        arrow.style.fontSize = '1.5em';
        arrow.style.color = '#7a63c6';
        card.appendChild(arrow);

        container.appendChild(card);
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€ Footer button UI â”€â”€â”€â”€â”€â”€â”€ */
    function updateFooterButtons() {
      document.querySelectorAll('.footer-button').forEach(b => b.classList.remove('active'));

      const activeSelector = showArchivedOnly ? '.archived-tasks' :
                             showMineOnly      ? '.your-tasks' :
                                                 '.all-tasks';
      const el = document.querySelector(activeSelector);
      if (el) el.classList.add('active');
    }
    function showYourTasks()   { showMineOnly=true; showArchivedOnly=false; updateFooterButtons(); renderTasks(); }
    function showAllTasks()    { showMineOnly=false; showArchivedOnly=false; updateFooterButtons(); renderTasks(); }
    function showArchivedTasks(){ showMineOnly=false; showArchivedOnly=true; updateFooterButtons(); renderTasks(); }

    /* â”€â”€â”€â”€â”€â”€â”€ Navigate to a single task page â”€â”€â”€â”€â”€â”€â”€ */
    async function goToTask(cardEl) {
      const title = cardEl.querySelector('h3').textContent;
      const projectId = 1;

      // numeric user id
      const uSnap = await db.collection('user')
        .where('email','==',currentUser.email).limit(1).get();
      if (uSnap.empty) return alert('User not found');
      const uid = uSnap.docs[0].data().id;

      // team that contains this user
      const tSnap = await db.collection('team')
        .where('project_id','==',projectId)
        .where('users','array-contains',uid).limit(1).get();
      if (tSnap.empty) return alert('Team not found');
      const teamId = tSnap.docs[0].data().team_id;

      // find the task by title + project + team
      const taskSnap = await db.collection('tasks')
        .where('title','==',title)
        .where('project_id','==',projectId)
        .where('team_id','==',teamId).limit(1).get();
      if (taskSnap.empty) return alert('Task not found');

      const taskId = taskSnap.docs[0].data().task_id;
      window.location.href = `/task.html?task_id=${encodeURIComponent(taskId)}`;
    }

    /* â”€â”€â”€â”€â”€â”€â”€ Addâ€‘Task FAB â”€â”€â”€â”€â”€â”€â”€ */
    async function initAddTaskButton() {
      const btn = document.getElementById('add-task-btn');
      btn.onclick = async () => {
        if (!currentUser) return alert('Log in first');
        const title = prompt('Task name:')?.trim();
        if (!title) return;

        const projectId = 1;
        const uSnap = await db.collection('user')
          .where('email','==',currentUser.email).limit(1).get();
        if (uSnap.empty) return alert('User not found');
        const uid = uSnap.docs[0].data().id;

        const tSnap = await db.collection('team')
          .where('project_id','==',projectId)
          .where('users','array-contains',uid).limit(1).get();
        if (tSnap.empty) return alert('Team not found');
        const teamId = tSnap.docs[0].data().team_id;

        const newTaskId = Date.now();   // numeric task_id
        await db.collection('tasks').add({
          title, project_id:projectId, team_id:teamId,
          email:currentUser.email, deadline:null,
          checklist:[], status:'inProgress', task_id:newTaskId
        });
        // onSnapshot will automatically refresh the list
      };
    }

    /* â”€â”€â”€â”€â”€â”€â”€ Page entry point â”€â”€â”€â”€â”€â”€â”€ */
    window.addEventListener('load', () => {
      auth.onAuthStateChanged(async user => {
        if (!user) {
          document.querySelector('.container').innerHTML = '<p>Please log in.</p>';
          return;
        }
        currentUser = user;
        try {
          await loadCurrentTeam();
          startTaskListener();
          initAddTaskButton();          // â† FAB now works
        } catch (e) {
          console.error(e);
          alert('Failed to load team data');
        }
      });
    });
  </script>
</body>
</html>