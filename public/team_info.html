<body>
  <div id="teamContainer"></div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyApNGohDeMrQWBewscU5PuBRR6BQ3m2uQQ",
    authDomain: "colabspace-aed91.firebaseapp.com",
    projectId: "colabspace-aed91",
    storageBucket: "colabspace-aed91.firebasestorage.app",
    messagingSenderId: "1096273499808",
    appId: "1:1096273499808:web:42012f619a3cbced321bc5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- Chart container ---
  function insertChartCanvas() {
    let chartDiv = document.getElementById('team-progress-chart-div');
    if (!chartDiv) {
      chartDiv = document.createElement('div');
      chartDiv.style.margin = "30px 0 20px";
      chartDiv.style.background = "#fff";
      chartDiv.style.borderRadius = "16px";
      chartDiv.style.boxShadow = "0 1px 4px rgba(0,0,0,0.07)";
      chartDiv.style.padding = "18px 10px";
      chartDiv.id = "team-progress-chart-div";
      chartDiv.innerHTML = `<h2 style="font-size:17px;margin-bottom:16px;text-align:center;color:#202124;font-weight:500;">Team Task Completion</h2>
        <canvas id="teamProgressChart" height="120"></canvas>`;
        const container = document.getElementById('teamContainer');
        if (!container) {
          console.error("teamContainer element not found");
          return;
        }
        if (container.parentNode) {
          container.parentNode.insertBefore(chartDiv, container.nextSibling);
        } else {
          console.error("teamContainer has no parentNode");
        }
      const button = document.createElement('button');
      button.textContent = "Go to My Personal Stats";
      button.style.display = "block";
      button.style.margin = "16px auto";
      button.style.padding = "8px 16px";
      button.style.fontSize = "14px";
      button.style.cursor = "pointer";
      button.onclick = () => { window.location.href = '/user_info.html'; };
      chartDiv.appendChild(button);
    }
  }

  function renderTeamChart(labels, data, memberTaskStats, currentUserIndex) {
    const ctx = document.getElementById('teamProgressChart');
    if (!ctx) {
      console.error("teamProgressChart canvas not found");
      return;
    }
    new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Completed Tasks (%)',
          data,
          backgroundColor: '#9c6ade',
          borderRadius: 4,
          barPercentage: 0.6,
          categoryPercentage: 0.5,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: { label: ctx => `${ctx.parsed.y}% complete` }
          },
          datalabels: {
            display: true,
            color: '#000',
            anchor: 'end',
            align: 'end',
            formatter: (value, context) => {
              const memberId = context.dataIndex;
              const stats = memberTaskStats[memberId];
              return `${stats.completed}/${stats.total}`;
            },
            font: { weight: 'bold', size: 12 }
          }
        },
        scales: {
          y: { min: 0, max: 100, ticks: { stepSize: 20, callback: v => v + "%" }, title: { display: true, text: "Completion %" } },
          x: { ticks: { font: { weight: 'bold', size: 13 } } }
        },
        onClick: (evt, elements) => {
          const points = elements;
          if (points.length) {
            const firstPoint = points[0];
            if (firstPoint.index === currentUserIndex) {
              window.location.href = '/user_info.html';
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  window.addEventListener('load', () => {
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) return;
      insertChartCanvas();

      const currentEmail = user.email;
      if (!currentEmail) return;

      try {
        // 1. Fetch user_id and numeric id from users collection by email
        const userSnap = await db.collection("user").where("email", "==", currentEmail).get();
        let userId = null;
        let numericUserId = null;
        userSnap.forEach(doc => {
          userId = doc.id;
          const data = doc.data();
          numericUserId = data.id !== undefined ? data.id : null;
        });
        if (!userId) {
          console.error("User not found in Firestore for email", currentEmail);
          return;
        }
      
        // 2. Find the team with project_id = 1 containing this userId or numericUserId
        const teamSnap = await db.collection("team").where("project_id", "==", 1).get();
        let foundTeam = null, teamId = null, memberIds = [];
        teamSnap.forEach(doc => {
          const data = doc.data();
          if (Array.isArray(data.users)) {
            // Check if members contains either userId or numericUserId
            if (data.users.includes(userId) || (numericUserId !== null && data.users.includes(numericUserId))) {
              foundTeam = data;
              teamId = doc.id;
              memberIds = data.users;
            }
          }
        });
        if (!foundTeam) {
          console.error("User is not part of any team for project 1");
          return;
        }

        // 3. Fetch emails of all team members
        // Firestore 'in' queries limited to 10 items, handle accordingly if needed
        const emailMap = {};
        const chunkSize = 10;

        // Separate memberIds into string IDs and numeric IDs
        const stringMemberIds = memberIds.filter(id => typeof id === 'string');
        const numericMemberIds = memberIds.filter(id => typeof id === 'number');

        // Fetch users by document ID for string IDs
        for (let i = 0; i < stringMemberIds.length; i += chunkSize) {
          const chunk = stringMemberIds.slice(i, i + chunkSize);
          const usersDocs = await db.collection("user").where(firebase.firestore.FieldPath.documentId(), "in", chunk).get();
          usersDocs.forEach(doc => {
            emailMap[doc.id] = doc.data().email || doc.id;
          });
        }

        // Fetch users by 'id' field for numeric IDs
        for (let i = 0; i < numericMemberIds.length; i += chunkSize) {
          const chunk = numericMemberIds.slice(i, i + chunkSize);
          const usersDocs = await db.collection("user").where("id", "in", chunk).get();
          usersDocs.forEach(doc => {
            const data = doc.data();
            if (data.id !== undefined) {
              emailMap[data.id] = data.email || String(data.id);
            }
          });
        }

        // Map memberIds to emails
        const memberEmails = memberIds.map(id => emailMap[id] || String(id));

        // Find index of current user in memberIds
        let currentUserIndex = memberIds.findIndex(id => {
          if (id === userId) return true;
          if (numericUserId !== null && id === numericUserId) return true;
          return false;
        });

        // 4. Fetch all tasks for project_id = 1 and team_id
        const tasksSnap = await db.collection("tasks")
          .where("project_id", "==", 1)
          .where("team_id", "==", teamId)
          .get();

        // 5. Compute completed vs total per member
        const taskStats = {};
        memberIds.forEach(id => { taskStats[id] = { total: 0, completed: 0 }; });
        tasksSnap.forEach(doc => {
          const t = doc.data();
          const assignee = t.user_id;
          if (memberIds.includes(assignee)) {
            taskStats[assignee].total += 1;
            if (t.status == 'Completed') taskStats[assignee].completed += 1;
          }
        });

        // 6. Prepare Chart.js data
        const labels = memberEmails;
        const data = memberIds.map(id =>
          taskStats[id].total
            ? Math.round((taskStats[id].completed / taskStats[id].total) * 100)
            : 0
        );

        // Prepare memberTaskStats array for datalabels plugin (indexed by member index)
        const memberTaskStats = memberIds.map(id => taskStats[id]);

        // 7. Render bar chart with click handler for current user
        renderTeamChart(labels, data, memberTaskStats, currentUserIndex);

      } catch (error) {
        console.error("Error loading team data:", error);
      }
    });
  });
</script>
  
</body>