<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA7UWjOXco-_ULw1fIYOLtQs1qVHXqYrX4",
          authDomain: "colabspace-aed91.firebaseapp.com",
      projectId: "colabspace-aed91",
      storageBucket: "colabspace-aed91.firebasestorage.app",
      messagingSenderId: "1096273499808",
      appId: "1:1096273499808:web:42012f619a3cbced321bc5"
        };
        firebase.initializeApp(firebaseConfig);
  </script>
  <script>
    firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) return;
      
        const db = firebase.firestore();
      
        // 1. Get numeric user_id
        const usersSnap = await db.collection("user")
                                  .where("email", "==", user.email)
                                  .get();
        if (usersSnap.empty) {
          console.log("User not found in Firestore");
          return;
        }
        const userDoc = usersSnap.docs[0];
        const numericUserId = userDoc.data().id;
      
        // 2. Get team_ids the user belongs to
        const teamSnap = await db.collection("team")
                                 .where("users", "array-contains", numericUserId)
                                 .get();
        const teamIds = teamSnap.docs.map(doc => doc.data().team_id);
      
        if (!teamIds.length) return; // no teams â†’ nothing to display
      
        // 3. Fetch tasks for these team_ids
        db.collection("tasks")
          .where("team_id", "in", teamIds)
          .onSnapshot(snapshot => {
            const container = document.querySelector('.container');
            container.innerHTML = ""; // clear existing static tasks

            // --- Begin new rendering and sorting logic ---
            // Collect task HTML and daysLeft for sorting
            let tasksToRender = [];
            snapshot.forEach(doc => {
              const task = doc.data();
              if (task.is_archived === true || task.is_deleted === true) return;

              // Responsible email styling
              const emailColor = task.email === user.email ? '#999' : '#333';

              // Deadline calculation
              let deadlineStr = '';
              let daysLeft = Infinity;
              if (!task.deadline) {
                deadlineStr = '<span style="color:#FF9800;">Deadline not set</span>';
              } else {
                let deadlineDate;
                if (typeof task.deadline === 'number') {
                  deadlineDate = new Date(task.deadline * 24*60*60*1000);
                } else {
                  deadlineDate = new Date(task.deadline);
                }
                const today = new Date();
                // Zero the time for today and deadline for accurate day difference
                today.setHours(0,0,0,0);
                deadlineDate.setHours(0,0,0,0);
                const diffTime = Math.ceil((deadlineDate - today)/(1000*60*60*24));
                daysLeft = diffTime;
                if (diffTime < 0) {
                  deadlineStr = '<span style="color:#FF9800;">Overdue</span>';
                } else {
                  deadlineStr = `Due in ${diffTime} day${diffTime !== 1 ? 's' : ''}`;
                }
              }

              const taskHtml = `
                <div class="task-card" data-days-left="${daysLeft}" onclick="window.location.href='task.html?task_id=${task.task_id}'" style="cursor:pointer;">
                  <div class="task-header">
                    <div style="display:flex;align-items:center;">
                      <span class="info-icon">â„¹</span>
                      <div>
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta" style="color:${emailColor};">Responsible: ${task.email}</div>
                        <div class="task-meta">Deadline: ${deadlineStr}</div>
                        <div class="task-meta">
                          Status: <span class="status-tag" style="
                              display:inline-block;
                              padding:2px 8px;
                              border-radius:12px;
                              font-size:12px;
                              font-weight:600;
                              color:#333;
                              background:${task.status && task.status.toLowerCase() === 'inprogress' ? '#FFD54F' : '#C8E6C9'};
                            ">
                            ${task.status && task.status.toLowerCase() === 'inprogress' ? 'Working' : 'Done'}
                          </span>
                        </div>
                        <div class="task-meta">
                          ${Array.isArray(task.checklist) && task.checklist.length > 0 ? `
                            <ul class="task-checklist">
                              ${task.checklist.map(item => `
                                <li style="margin:4px 0; list-style: disc inside;">
                                  <input type="checkbox" disabled ${item.done ? 'checked' : ''}>
                                  <strong>${item.Title || 'No title'}</strong>
                                  ${item.Description ? ` - ${item.Description}` : ''}
                                  ${item.Deadline ? ` (Due: ${new Date(item.Deadline * 24*60*60*1000).toLocaleDateString()})` : ''}
                                </li>
                              `).join('')}
                            </ul>
                          ` : '<span style="color:#999;">No checklist items</span>'}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
              tasksToRender.push({html: taskHtml, daysLeft: daysLeft});
            });
            // Sort by daysLeft (nearest first)
            tasksToRender.sort((a, b) => a.daysLeft - b.daysLeft);
            tasksToRender.forEach(t => {
              container.insertAdjacentHTML("beforeend", t.html);
            });
            // --- End new rendering and sorting logic ---
          });
      });
  </script>
  <script>
    function markDone(taskId) {
        const db = firebase.firestore();
        const taskRef = db.collection("tasks").where("task_id", "==", taskId).limit(1);
      
        taskRef.get().then(snap => {
          if (snap.empty) return;
          snap.docs[0].ref.update({ status: "Completed" });
        });
      }
  </script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
      padding: 20px 16px;
      line-height: 1.5;
    }
    .header {
      margin-bottom: 24px;
    }
    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 4px 0;
    }
    .header p {
      font-size: 18px;
      margin: 0;
      color: #000;
    }
    .menu-card {
      background: white;
      border-radius: 16px;
      padding: 16px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }
    /* Updated menu-item to ensure the link covers the whole area cleanly */
    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px; /* Adjust padding to be around the link */
      font-size: 17px;
    }
    .menu-link { /* New style for the anchor tag */
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 12px 0; /* Add vertical padding here */
        text-decoration: none; /* Remove underline */
        color: inherit; /* Keep text color the same */
    }
    .menu-item .star {
      font-size: 20px;
      margin-right: 12px;
    }
    .menu-item .desc {
      flex: 1;
      font-size: 14px;
      color: #666;
    }
    .status-box {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .status-box p {
      margin: 0 0 12px 0;
      font-size: 16px;
    }
    .progress-container {
      height: 12px;
      background: #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
    }
    .progress-bar {
      width: 40%;
      height: 100%;
      background: linear-gradient(to right, #6200ea, #b388ff);
      border-radius: 6px;
    }
    .task-card {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
    }
    .task-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .task-header img {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      margin-right: 12px;
    }
    .task-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    .task-meta {
      font-size: 14px;
      color: #666;
      margin: 4px 0;
    }
    .btn {
      align-self: flex-start;
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }
    .btn-done {
      background: #e0e0e0;
      color: #333;
    }
    .info-icon {
      font-size: 24px;
      margin-right: 12px;
      color: #666;
    }
    .back-btn {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 56px;
      height: 56px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      color: #333;
      z-index: 100;
      cursor: pointer;
      border: none;
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>Hi, {User} ðŸ‘‹</h1>
    <p>Ready to contribute?</p>
  </div>

  <div class="menu-card">
    <div class="menu-item">
        <a href="/team_info.html" class="menu-link">
          <div style="display:flex;align-items:center;">
            <span class="star">â˜…</span>
            <div>
              <div>Team Info</div>
              <!-- <div class="desc">Menu description.</div> -->
            </div>
          </div>
          <span>â†’</span>
        </a>
    </div>

    <div class="menu-item">
        <a href="/project_info.html" class="menu-link">
          <div style="display:flex;align-items:center;">
            <span class="star">â˜…</span>
            <div>
              <div>Project Info</div>
              <!-- <div class="desc">Menu description.</div> -->
            </div>
          </div>
          <span>â†’</span>
        </a>
    </div>

    <!-- <div class="menu-item">
        <a href="discussion_example.html" class="menu-link">
          <div style="display:flex;align-items:center;">
            <span class="star">â˜…</span>
            <div>
              <div>Discussion</div>
              <div class="desc">Menu description.</div>
            </div>
          </div>
          <span>â†’</span>
        </a>
    </div> -->
  </div>

  <div class="status-box">
    <p>Keep it up!</p>
    <p>Your current status is</p>
    <div class="progress-container">
      <div class="progress-bar"></div>
    </div>
  </div>
  <div class="container"></div>

  <script>
    let userName = "User";
  </script>


  <div class="back-btn" onclick="window.location.href='/group_choices.html'">â†©</div>
  <script>
    firebase.auth().onAuthStateChanged(async user => {
        if (user) {
            userName = user.displayName || "User";
    
            // Replace placeholder
            document.querySelector(".header h1").innerHTML =
                `Hi, ${userName} ðŸ‘‹`;

            const db = firebase.firestore();
            const usersSnap = await db.collection("user").where("email", "==", user.email).get();
            if (usersSnap.empty) return;
            const userId = usersSnap.docs[0].data().id;

            // Fetch all teams (all team members) the user belongs to
            const teamSnap = await db.collection("team").where("users", "array-contains", userId).get();
            const teamIds = teamSnap.docs.map(doc => doc.data().team_id);

            if (teamIds.length) {
                const tasksSnap = await db.collection("tasks")
                                          .where("team_id", "in", teamIds)
                                          .get();

                let completedTasks = 0;
                let totalTasks = 0;

                tasksSnap.forEach(doc => {
                    const t = doc.data();
                    if (!t || t.is_deleted === true) return; // Exclude deleted
                    totalTasks++;
                    if (t.status && t.status.toLowerCase() === "completed") completedTasks++;
                });

                const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                // Add a label above the progress bar
                let progressContainer = document.querySelector(".progress-container");
                let label = progressContainer.querySelector(".progress-label");
                if (!label) {
                    label = document.createElement("div");
                    label.className = "progress-label";
                    label.style.fontSize = "14px";
                    label.style.fontWeight = "600";
                    label.style.marginBottom = "4px";
                    progressContainer.parentNode.insertBefore(label, progressContainer);
                }
                label.textContent = `${completedTasks} / ${totalTasks} tasks completed`;

                // Update progress bar width
                document.querySelector(".progress-bar").style.width = progressPercent + "%";
            }
        } else {
            // Not signed in â†’ redirect or keep placeholder
            // window.location.href = "/login.html";
        }
    });
    </script>
</body>
</html>